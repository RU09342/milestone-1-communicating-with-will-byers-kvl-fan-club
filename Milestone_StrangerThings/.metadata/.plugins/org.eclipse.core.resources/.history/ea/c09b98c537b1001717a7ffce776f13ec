/*  Milestone 1: Stranger Things Light Wall
 *      Author: Damon Boorstein
 *              Rowan University
 *      Date Created: 10/12/17
 *          Updated: 10/13/17
 */


#include <initGPIO.h>
#include <initTimer.h>
#include <initUART.h>
#include <msp430fr6989.h>

void initGPIO();
void initTimer();
void initUART();

int main(void)
{
	WDTCTL = WDTPW | WDTHOLD;	// stop watchdog timer

    initGPIO();            // initialize GPIOs and disable default high impedance mode
    initTimer();           // initialize Timer module
    initUART();            // initialize UART registers

    __bis_SR_register(LPM3_bits + GIE);     // enter LPM3, interrupts enabled
    __no_operation();                       // for debugging
}

#if defined(__TI_COMPILER_VERSION__) || defined(__IAR_SYSTEMS_ICC__)
#pragma vector=USCI_A0_VECTOR
__interrupt void USCI_A0_ISR(void)
#elif defined(__GNUC__)
void __attribute__ ((interrupt(USCI_A0_VECTOR))) USCI_A0_ISR (void)
#else
#error Compiler not supported!
#endif
{
  switch(__even_in_range(UCA0IV, USCI_UART_UCTXCPTIFG))
  {
    case USCI_NONE: break;
    case USCI_UART_UCRXIFG:
      while(!(UCA0IFG&UCTXIFG));
      UCA0TXBUF = UCA0RXBUF;
      __no_operation();
      break;
    case USCI_UART_UCTXIFG: break;
    case USCI_UART_UCSTTIFG: break;
    case USCI_UART_UCTXCPTIFG: break;
  }
}

#pragma vector = TIMER0_A1_VECTOR
__interrupt void Timer0_A1(void)
{
    P9OUT ^= LED2;  // Toggle LED2
    if (!(P1IN & BUTTON)) // If button has not been released yet...
    {
        if (buttonDown == 0) // and if buttonDown is false
        {
            buttonDown = 1; // Debounce

            if (x >= 1250)
                x = 1; // Reset TA0CCR1 (TA0CCR1 = 1 - 1 = 0)

            else
                x += 125; // Increment Duty Cycle

            TA0CCR1 = x - 1; // Set value for CCR1
        }
    }

    P1IES ^= BUTTON; // Toggle to allow for redo LED toggle when button is released
    P1IFG &= ~BUTTON; // Clear P2 interrupt flag

}




